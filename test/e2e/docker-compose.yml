# Minimal Redmine + Hocuspocus setup for E2E testing
services:
  redmine:
    build:
      context: ../..  # Plugin root directory
      dockerfile: test/e2e/Dockerfile.redmine
      args:
        REDMINE_TAG: ${REDMINE_TAG:-6.0}
    container_name: redmine_yjs_test_app
    depends_on:
      hocuspocus:
        condition: service_healthy
    environment:
      REDMINE_DB_SQLITE: "true"
      CONTAINER_NAME: "redmine_direct"
      RAILS_ENV: production
      REDMINE_ADMIN_PASSWORD: "admin123"
      SECRET_KEY_BASE: test-secret-key-for-e2e-testing
      WEB_CONCURRENCY: 0
      RAILS_MAX_THREADS: 2
      RAILS_LOG_TO_STDOUT: "true"
      REDMINE_LOAD_DEFAULT_DATA: "true"
      REDMINE_LANG: en
      HOCUSPOCUS_URL: "ws://0.0.0.0:8081"
      YJS_ENABLED: "1"
      # Shared HMAC secret for Redmine â†’ Hocuspocus auth tokens (32 bytes, demo value)
      YJS_TOKEN_SECRET: "9c3b2f4a6d8e0f1a2b3c4d5e6f7081929c3b2f4a6d8e0f1a2b3c4d5e6f70819-changeme"
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 90s

  hocuspocus:
    build:
      context: ../../hocuspocus
      dockerfile: Dockerfile
    container_name: redmine_yjs_test_hocuspocus
    environment:
      PORT: 8081
      HOCUSPOCUS_PORT: 8081
      YJS_ENABLED: "1"
      # Must match the secret set for Redmine above
      YJS_TOKEN_SECRET: "9c3b2f4a6d8e0f1a2b3c4d5e6f7081929c3b2f4a6d8e0f1a2b3c4d5e6f70819-changeme"
    ports:
      - "8081:8081"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8081/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

