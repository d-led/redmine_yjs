# Minimal Redmine + Hocuspocus setup for E2E testing
# Self-contained - uses official Redmine image
#
# Usage:
#   cd test/e2e && docker-compose -f docker-compose.test.yml up --build
#   ./scripts/run-tests.sh
#
services:
  redmine:
    build:
      context: ../..  # Plugin root directory
      dockerfile: test/e2e/Dockerfile.redmine
    container_name: redmine_yjs_test_app
    depends_on:
      hocuspocus:
        condition: service_healthy
    environment:
      REDMINE_DB_SQLITE: "true"
      RAILS_ENV: production
      REDMINE_ADMIN_PASSWORD: "admin123"
      SECRET_KEY_BASE: test-secret-key-for-e2e-testing
      WEB_CONCURRENCY: 0
      RAILS_MAX_THREADS: 2
      RAILS_LOG_TO_STDOUT: "true"
      REDMINE_LOAD_DEFAULT_DATA: "true"
      REDMINE_LANG: en
      HOCUSPOCUS_URL: "ws://0.0.0.0:8081"
      YJS_ENABLED: "1"
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 90s

  redmine-proxy:
    build:
      context: ../..  # Plugin root directory
      dockerfile: test/e2e/Dockerfile.redmine-proxy
    container_name: redmine_yjs_test_app_proxy
    depends_on:
      hocuspocus:
        condition: service_healthy
    environment:
      REDMINE_DB_SQLITE: "true"
      RAILS_ENV: production
      REDMINE_ADMIN_PASSWORD: "admin123"
      SECRET_KEY_BASE: test-secret-key-for-e2e-testing-proxy
      WEB_CONCURRENCY: 0
      RAILS_MAX_THREADS: 2
      RAILS_LOG_TO_STDOUT: "true"
      REDMINE_LOAD_DEFAULT_DATA: "true"
      REDMINE_LANG: en
      HOCUSPOCUS_URL: "ws://0.0.0.0:8081"
      HOCUSPOCUS_INTERNAL_URL: "ws://hocuspocus:8081"
      YJS_ENABLED: "1"
    ports:
      - "3001:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 90s

  hocuspocus:
    build:
      context: ../../hocuspocus
      dockerfile: Dockerfile
    container_name: redmine_yjs_test_hocuspocus
    environment:
      PORT: 8081
      HOCUSPOCUS_PORT: 8081
      YJS_ENABLED: "1"
    ports:
      - "8081:8081"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8081/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
