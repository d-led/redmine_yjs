# Test Redmine image with redmine_yjs plugin and WebSocket proxy enabled
# Based on official Redmine image
ARG REDMINE_TAG=6.0

FROM redmine:${REDMINE_TAG}

# Install build tools for native extensions and other dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    sqlite3 \
    libsqlite3-dev \
    libyaml-dev \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src/redmine

# Install CKEditor plugin for testing
RUN if [ ! -d "plugins/redmine_ckeditor" ]; then \
      echo "Installing CKEditor plugin..."; \
      git clone --depth 1 --branch master https://github.com/a-ono/redmine_ckeditor.git plugins/redmine_ckeditor || \
      git clone --depth 1 https://github.com/a-ono/redmine_ckeditor.git plugins/redmine_ckeditor || \
      echo "Warning: Could not install CKEditor plugin"; \
    fi

# Copy the plugin (context is plugin root)
COPY . /usr/src/redmine/plugins/redmine_yjs/

# Copy plugin assets to public directory (Redmine 6.x requirement)
RUN mkdir -p /usr/src/redmine/public/plugin_assets/redmine_yjs \
    && cp -r /usr/src/redmine/plugins/redmine_yjs/assets/* /usr/src/redmine/public/plugin_assets/redmine_yjs/ 2>/dev/null || true

# Add websocket-client-simple gem for ActionCable proxy mode
RUN echo "gem 'websocket-client-simple', '~> 0.3.0', require: false" >> Gemfile || true

# Create temporary database.yml so sqlite3 gem gets installed during bundle install
# (Redmine's Gemfile installs sqlite3 conditionally based on database.yml)
RUN mkdir -p config && \
    echo "production:" > config/database.yml && \
    echo "  adapter: sqlite3" >> config/database.yml && \
    echo "  database: /tmp/redmine.sqlite3" >> config/database.yml

# Install gems for plugins
# CKEditor's Gemfile may have dependencies that conflict, so we disable it
# CKEditor will still work without its optional Gemfile dependencies
RUN if [ -f "plugins/redmine_ckeditor/Gemfile" ]; then \
      mv plugins/redmine_ckeditor/Gemfile plugins/redmine_ckeditor/Gemfile.disabled || true; \
    fi && \
    bundle config set --local without 'development test' && \
    bundle config set --local path '/usr/local/bundle' && \
    bundle install --jobs 4 --retry 3

# Remove temporary database.yml (entrypoint will create the real one)
RUN rm -f config/database.yml

# Copy ActionCable config for WebSocket proxy mode
COPY test/e2e/cable.yml /usr/src/redmine/config/cable.yml

# Copy entrypoint script (same as regular test image)
COPY test/e2e/test-entrypoint.sh /usr/local/bin/test-entrypoint.sh
RUN chmod +x /usr/local/bin/test-entrypoint.sh

EXPOSE 3000

ENTRYPOINT ["/usr/local/bin/test-entrypoint.sh"]
