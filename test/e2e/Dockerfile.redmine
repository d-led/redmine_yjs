# Test Redmine image with redmine_yjs plugin pre-installed
# Based on official Redmine image
ARG REDMINE_TAG=6.0

FROM redmine:${REDMINE_TAG}

# Install SQLite and curl for health checks
RUN apt-get update && apt-get install -y --no-install-recommends \
    sqlite3 \
    libsqlite3-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install sqlite3 gem
RUN echo "gem 'sqlite3', '~> 1.7'" >> /usr/src/redmine/Gemfile \
    && bundle install --without development test

WORKDIR /usr/src/redmine

# Copy the plugin (context is plugin root)
COPY . /usr/src/redmine/plugins/redmine_yjs/

# Copy plugin assets to public directory (Redmine 6.x requirement)
RUN mkdir -p /usr/src/redmine/public/plugin_assets/redmine_yjs \
    && cp -r /usr/src/redmine/plugins/redmine_yjs/assets/* /usr/src/redmine/public/plugin_assets/redmine_yjs/ 2>/dev/null || true

# Create entrypoint script for test setup
RUN cat > /usr/local/bin/test-entrypoint.sh << 'EOF'
#!/bin/bash
set -e

cd /usr/src/redmine

# Create SQLite database config
if [ "${REDMINE_DB_SQLITE}" = "true" ]; then
  mkdir -p /data/db
  cat > config/database.yml << DBCONF
production:
  adapter: sqlite3
  database: /data/db/redmine.sqlite3
  timeout: 5000
DBCONF
fi

# Run migrations
bundle exec rake db:migrate RAILS_ENV=production 2>/dev/null || bundle exec rake db:migrate RAILS_ENV=production
bundle exec rake redmine:plugins:migrate RAILS_ENV=production || true

# Load default data if needed
if [ "${REDMINE_LOAD_DEFAULT_DATA}" = "true" ]; then
  bundle exec rake redmine:load_default_data RAILS_ENV=production REDMINE_LANG=${REDMINE_LANG:-en} 2>/dev/null || true
fi

# Set admin password
if [ -n "${REDMINE_ADMIN_PASSWORD}" ]; then
  bundle exec rails runner "u=User.find_by_login('admin'); u.password=u.password_confirmation='${REDMINE_ADMIN_PASSWORD}'; u.must_change_passwd=false; u.save!" RAILS_ENV=production 2>/dev/null || true
fi

# Clear cache
bundle exec rake tmp:cache:clear RAILS_ENV=production 2>/dev/null || true

# Start Rails
exec bundle exec rails server -b 0.0.0.0 -p 3000
EOF

RUN chmod +x /usr/local/bin/test-entrypoint.sh

EXPOSE 3000

ENTRYPOINT ["/usr/local/bin/test-entrypoint.sh"]

